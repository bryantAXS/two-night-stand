/*
 * ExpressionEngine - by EllisLab
 *
 * @package		ExpressionEngine
 * @author		ExpressionEngine Dev Team
 * @copyright	Copyright (c) 2003 - 2010, EllisLab, Inc.
 * @license		http://expressionengine.com/docs/license.html
 * @link		http://expressionengine.com
 * @since		Version 2.0
 * @filesource
 */
/*
 * ExpressionEngine Filebrowser Plugin
 *
 * @package		ExpressionEngine
 * @subpackage	Control Panel
 * @category	Control Panel
 * @author		ExpressionEngine Dev Team
 * @link		http://expressionengine.com
 */
(function(g){var h,i,f,n,j,d=0,l=EE.filebrowser.theme_url+"images/publish_file_manager_loader.gif",a=EE.PATH_CP_GBL_IMG+"default.png",c,m;g.ee_filebrowser=function(){h=20;g.ee_filebrowser.endpoint_request("setup",function(q){i={};f={};c=g(q.manager).appendTo(document.body);for(var r in q.directories){if(!d){d=r}i[r]=""}e()})};g.ee_filebrowser.endpoint_request=function(q,r,s){if(!s&&g.isFunction(r)){s=r;r={}}r=g.extend(r,{action:q});g.getJSON(EE.BASE+"&"+EE.filebrowser.endpoint_url+"&"+g.param(r),s)};g.ee_filebrowser.add_trigger=function(q,r,s){if(!s&&g.isFunction(r)){s=r;r="userfile"}g(q).click(function(){g("#upload_file",c).attr("name",r);c.dialog("open");j=function(t){s.call(q,t,r)};return false})};g.ee_filebrowser.change_dim=function(s,r){if(g("#cloned #constrain:checked").length==0){return}if(r.attr("id")=="resize_width"){var q=s.height/s.width;g("#resize_height").val(Math.floor(q*r.val()))}else{var q=s.width/s.height;g("#resize_width").val(Math.floor(q*r.val()))}};g.ee_filebrowser.submit_image_edit=function(q,r){g.ajax({type:"POST",url:EE.BASE+"&"+EE.filebrowser.endpoint_url+"&action=edit_image",data:g("#image_edit_form").serialize(),success:function(s){q.name=s;q.dimensions='width="'+q.width+'" height="'+q.height+'" ';g.ee_filebrowser.clean_up(q,r)},error:function(s){if(g.ee_notice){g.ee_notice(s.responseText,{type:"error"})}else{s.responseText=s.responseText.replace(/<p>/,"");alert(s.responseText.replace(/<\/p>/,""))}}})};g.ee_filebrowser.clean_up=function(q,r){g("#page_0 .items").html(r);c.dialog("close");j(q)};g.ee_filebrowser.reset=function(){g("#file_manager").scrollable({api:true}).begin()};var k={upload_start:function(){g("#progress",c).show()},upload_success:function(q){i[q.directory]="";g("#page_"+q.directory+" .items",c).empty();g("#progress",c).hide();var r=g("#page_0 .items").html();if(q.is_image){g("#page_0 .items").html('<button id="resize_image"><span>'+EE.lang.resize_image+"</span></button> "+EE.lang.or+' <button class="place_image"><span>'+EE.lang.return_to_publish+"</span></button>").fadeIn("fast");g(".place_image").click(function(){g.ee_filebrowser.clean_up(q,r)});g("#resize_image").click(function(){g("#page_0 .items").html(g(".image_edit_form_options").clone().css("display","block").attr("id","cloned"));g("#resize_width").val(q.width);g("#resize_height").val(q.height);g("#file").val(q.url_path);g("#resize_width, #resize_height").keyup(function(){g.ee_filebrowser.change_dim(q,g(this))});g(".place_image").click(function(){g.ee_filebrowser.clean_up(q,r)});g(".icons li").click(function(){var s=g(this).attr("class");switch(s){case"rotate_90r":rotate=90;break;case"rotate_90l":rotate=270;break;case"rotate_180":rotate=180;break;case"rotate_flip_vert":rotate="vrt";break;case"rotate_flip_hor":rotate="hor";break;default:rotate="none"}g("#image_edit_form input:text").val("");g("#image_edit_form").prepend('<input type="hidden" name="rotate" value="'+rotate+'"/>');g.ee_filebrowser.submit_image_edit(q,r)});g("#image_edit_form").submit(function(){if(g("#crop_width").val()==""&&g("#crop_height").val()==""&&g("#crop_x").val()==""&&g("#crop_y").val()==""&&g("#resize_width").val()==""&&g("#resize_height").val()==""){g.ee_filebrowser.clean_up(q,r)}else{q.width=g("#resize_width").val();q.height=g("#resize_height").val();g.ee_filebrowser.submit_image_edit(q,r)}return false})})}else{g.ee_filebrowser.clean_up(q,r)}},upload_error:function(q){g("#progress",c).hide();if(g.ee_notice){g.ee_notice(q.error,{type:"error"})}else{q.error=q.error.replace(/<p>/,"");alert(q.error.replace(/<\/p>/,""))}console.log(q)}};g.ee_filebrowser=g.extend(g.ee_filebrowser,k);function b(r){if(!r.id in i){return}i[r.id]=r.files;f[r.id]=r.url;var q="",s=0,u=[],t=g("#page_"+r.id,c).scrollable();g.each(r.files,function(v,w){if(v%h==0&&v!=0){u.push(q);q=""}if(w.mime==false||w.mime.indexOf("image")<0){q+='<div><div title="{filedir_'+r.id+"}|"+w.name+'"><img title="'+a+'" src="'+a+'" alt="default thumbnail" /></div>'+w.name+"</div>"}else{q+="<div><div title='"+w.dimensions+'\'><img class="image" title="{filedir_'+r.id+"}"+w.name+'" src="';if(!w.has_thumb){q+=a;if(v<h){g.ajax({type:"POST",url:EE.BASE+"&"+EE.filebrowser.endpoint_url+"&action=ajax_create_thumb",data:"XID="+EE.XID+"&dir="+r.id+"&image="+w.name})}}else{if(v<h){q+=r.url+"_thumbs/thumb_"+w.name}else{q+=l}}q+='" alt="thumbnail" /></div>'+w.name+"</div>"}s++});u.push(q);q=u.join('</div><div class="item">');t.getItemWrap().append('<div class="item">'+q+"</div>");t.reload();g(".item > div",c).unbind();g(".item > div",c).click(function(){var w,v=!(g(this).find("img").attr("src")==a);if(v===true){w={is_image:true,thumb:g(this).find("img").attr("src"),directory:d,dimensions:g(this).find("div").attr("title"),name:g(this).find("img").attr("title").split("}")[1]}}else{w={is_image:false,thumb:a,directory:d,name:g(this).find("div").attr("title").split("|")[1]}}j(w);c.dialog("close")});if(t.getPageAmount()==1){g("#nav_controls_"+r.id,c).hide()}else{g("#nav_controls_"+r.id,c).show()}}function p(q){if(i[q]==""){g.ee_filebrowser.endpoint_request("directory_contents",{directory:q},b)}}function o(q){var s=g("#page_"+q).scrollable();page_index=(s.getPageIndex()=="")?0:s.getPageIndex();if(g("#page_"+q+" .item:eq("+page_index+") img").length>0){var r={};g("#page_"+q+" .item:eq("+page_index+") img").each(function(v){var x=g(this);var w=/^\{filedir_(\d+)\}/;var u=w.exec(x.attr("title"));if(x.attr("src")==l){r[v]=f[u[1]]+"/_thumbs/thumb_"+x.attr("title").replace(w,"");g('<img src="'+r[v]+'" />').load(function(){x.attr("src",r[v])})}else{if(x.attr("class")=="image"&&x.attr("src")==a){x.attr("src",l);var t=x.attr("title").substring(x.attr("title").indexOf("}")+1);g.ajax({type:"POST",url:EE.BASE+"&"+EE.filebrowser.endpoint_url+"&action=ajax_create_thumb",data:"XID="+EE.XID+"&dir="+q+"&image="+t,success:function(y){x.attr("src",f[u[1]]+"/_thumbs/thumb_"+x.attr("title").replace(w,""))},error:function(){x.attr("src",a)}})}}})}}function e(){c.dialog({width:730,height:495,resizable:false,position:["center","center"],modal:true,draggable:true,title:EE.filebrowser.window_title,autoOpen:false,open:function(q,r){g("#file_manager_main").scrollable().getConf().keyboard="static";g("#file_manager_main").scrollable().reload();g(".vertscrollable").scrollable().getConf().keyboard=true;g(".vertscrollable").scrollable().reload()},close:function(q,r){g("#file_manager_main").scrollable().getConf().keyboard=false;g("#file_manager_main").scrollable().reload();g("#main_navi li:first").click()}});g("#file_manager_main").scrollable({vertical:true,size:1,clickable:false,speed:250,keyboard:false,onSeek:function(q){if(m!=q){m=q;d=g("li:eq("+q+")","#main_navi").attr("id").replace(/main_navi_/,"");p(d);o(d);focused_tab.scrollable(q).focus();g("#page_"+d).scrollable().reload()}}}).navigator("#main_navi");focused_tab=g(".vertscrollable").scrollable({size:1,clickable:false,nextPage:".newThumbs",prevPage:".prevThumbs",keyboard:false,onBeforeSeek:function(q){if(g("#file_manager_main:visible").length==0){this.getConf().keyboard=false;this.reload()}},onSeek:function(q){o(d)}}).navigator({navi:".navi"});p(d);o(d);focused_tab.eq(0).scrollable().focus();g("#upload_form",c).submit(g.ee_filebrowser.upload_start)}})(jQuery);